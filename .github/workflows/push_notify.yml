name: Notify on Push

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout repo
        uses: actions/checkout@v3

      - name: 📥 Install msmtp
        run: sudo apt-get update && sudo apt-get install -y msmtp

      - name: 🛠️ Configure msmtp
        run: |
          cat <<EOF > ~/.msmtprc
          defaults
          tls on
          tls_starttls on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt
          account default
          host ${{ secrets.SMTP_HOST }}
          port ${{ secrets.SMTP_PORT }}
          auth on
          user ${{ secrets.SMTP_USERNAME }}
          password ${{ secrets.SMTP_PASSWORD }}
          from ${{ secrets.EMAIL_FROM }}
          logfile ~/.msmtp.log
          EOF
          chmod 600 ~/.msmtprc

      - name: 📝 Create email message
        run: |
          cat <<EOF > message.txt
          Subject: Nouveau push sur le dépôt « ${{ github.event.repository.name }} »
          MIME-Version: 1.0
          Content-Type: multipart/alternative; boundary="separator"

          --separator
          Content-Type: text/plain; charset="UTF-8"

          Bonjour,

          Un nouveau push a été effectué sur le dépôt « ${{ github.event.repository.name }} ».

          Author : ${{ github.actor }}
          Branch : ${{ github.ref_name }}
          Commit message :
          ${{ github.event.head_commit.message }}

          Link : https://github.com/${{ github.repository }}/commit/${{ github.sha }}

          Best regards,  
          Nightm@r3_N1nj@s Team

          --separator
          Content-Type: text/html; charset="UTF-8"

          <html>
            <body style="font-family: Arial, sans-serif;">
              <h2>A new push was made to the repository <em>${{ github.event.repository.name }}</em></h2>
              <p><strong>Author :</strong> ${{ github.actor }}<br>
                 <strong>Branch :</strong> ${{ github.ref_name }}</p>
              <p><strong>Commit message :</strong><br>
                 <em>${{ github.event.head_commit.message }}</em></p>
              <p>🔗 <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">Voir le commit complet</a></p>
              <p style="margin-top:20px;">Best regards,<br><em>Nightm@r3_N1nj@s Team</em></p>
            </body>
          </html>

          --separator--
          EOF

      - name: 📤 Send email to members
        run: |
          IFS=',' read -ra ADDR <<< "${{ secrets.EMAILS_MEMBERS }}"
          for email in "${ADDR[@]}"; do
            cat message.txt | msmtp "$email"
            echo "✅ Email envoyé à $email"
          done
